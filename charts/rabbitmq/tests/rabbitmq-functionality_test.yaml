suite: test RabbitMQ functionality
templates:
  - templates/statefulset.yaml
  - templates/service.yaml
  - templates/secret.yaml
  - templates/configmap.yaml
  - templates/ingress.yaml
  - templates/servicemonitor.yaml
set:
  image:
    tag: 4.1.3-managemen@sha256:4c521003d812dd7b33793e2b7e45fbcc323d764b8c3309dfcb0e4c5db30c56ab
tests:
  - it: should create statefulset with correct image
    asserts:
      - isKind:
          of: StatefulSet
        template: templates/statefulset.yaml
      - equal:
          path: spec.template.spec.containers[0].image
          value: docker.io/rabbitmq:4.1.3-managemen@sha256:4c521003d812dd7b33793e2b7e45fbcc323d764b8c3309dfcb0e4c5db30c56ab
        template: templates/statefulset.yaml

  - it: should expose correct ports
    template: templates/service.yaml
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 5672
            targetPort: amqp
            name: amqp
      - contains:
          path: spec.ports
          content:
            port: 15672
            targetPort: mgmt
            name: mgmt

  - it: should create secret with password and erlang cookie when auth enabled
    set:
      auth:
        enabled: true
        password: ""
        erlangCookie: ""
    template: templates/secret.yaml
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data.password
      - exists:
          path: data["erlang-cookie"]

  - it: should not create secret when existing secret is provided
    set:
      auth:
        existingSecret: my-existing-secret
    template: templates/secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should configure memory watermark correctly
    set:
      config:
        memoryHighWatermark:
          enabled: true
          type: relative
          value: 0.6
    template: templates/configmap.yaml
    asserts:
      - matchRegex:
          path: data["rabbitmq.conf"]
          pattern: "vm_memory_high_watermark.relative = 0.6"

  - it: should enable clustering when configured
    set:
      replicaCount: 3
      peerDiscoveryK8sPlugin:
        enabled: true
    asserts:
      - equal:
          path: spec.replicas
          value: 3
        template: templates/statefulset.yaml
      - matchRegex:
          path: data["rabbitmq.conf"]
          pattern: "cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s"
        template: templates/configmap.yaml

  - it: should configure clustering environment variables
    set:
      peerDiscoveryK8sPlugin:
        enabled: true
    template: templates/statefulset.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RABBITMQ_USE_LONGNAME
            value: "true"

  - it: should configure resources correctly
    set:
      resources:
        requests:
          cpu: 200m
          memory: 1Gi
        limits:
          cpu: 1000m
          memory: 2Gi
    template: templates/statefulset.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi

  - it: should enable metrics when configured
    set:
      metrics:
        enabled: true
        port: 15692
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: prometheus
            containerPort: 15692
        template: templates/statefulset.yaml
      - contains:
          path: spec.ports
          content:
            port: 15692
            targetPort: prometheus
            name: prometheus
        template: templates/service.yaml

  - it: should create ServiceMonitor when metrics and serviceMonitor enabled
    set:
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    template: templates/servicemonitor.yaml
    asserts:
      - isKind:
          of: ServiceMonitor
      - equal:
          path: spec.endpoints[0].port
          value: prometheus

  - it: should configure persistence correctly
    set:
      persistence:
        enabled: true
        size: 10Gi
        storageClass: fast-ssd
    template: templates/statefulset.yaml
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: "10Gi"
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: "fast-ssd"

  - it: should create and configure ingress correctly when enabled
    set:
      service:
        managementPort: 15672
      ingress:
        enabled: true
        hosts:
          - host: rabbitmq.example.com
            paths:
              - path: /
                pathType: Prefix
    template: templates/ingress.yaml
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: spec.rules[0].host
          value: rabbitmq.example.com
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 15672

  - it: should configure security contexts correctly
    set:
      podSecurityContext:
        fsGroup: 999
      securityContext:
        runAsUser: 999
        runAsNonRoot: true
        allowPrivilegeEscalation: false
    template: templates/statefulset.yaml
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 999
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 999
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false

  - it: should configure health probes correctly
    set:
      livenessProbe:
        enabled: true
        initialDelaySeconds: 60
        periodSeconds: 30
      readinessProbe:
        enabled: true
        initialDelaySeconds: 10
        periodSeconds: 10
    template: templates/statefulset.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 10

  - it: should set correct environment variables for authentication
    set:
      auth:
        enabled: true
        username: testuser
    template: templates/statefulset.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RABBITMQ_DEFAULT_USER
            value: testuser
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: RABBITMQ_DEFAULT_PASS
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-rabbitmq
                key: password

  - it: should mount volumes correctly
    template: templates/statefulset.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: data
            mountPath: /var/lib/rabbitmq
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config
            mountPath: /etc/rabbitmq

  - it: should configure extra configuration when provided
    set:
      config:
        extraConfiguration: |
          management.rates_mode = basic
          collect_statistics_interval = 10000
    template: templates/configmap.yaml
    asserts:
      - matchRegex:
          path: data["rabbitmq.conf"]
          pattern: "management.rates_mode = basic"
      - matchRegex:
          path: data["rabbitmq.conf"]
          pattern: "collect_statistics_interval = 10000"